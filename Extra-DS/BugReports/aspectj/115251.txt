BCException when compiling incrementally on constructor-call shadow
I get the same BCException when I build incrementally but not after cleaning the project. The code is correct (I think) and runs fine after clean-and-build. AJDT Build id: 20051104134042 AspectJ version: 1.5.0.200510241400 (Sorry if this is another manifestation of a different bug or an AJDT bug.) --------------------------------------------------------------- ----------------- Singleton.java package com.isberg.articles.aop7.patterns; /** * CODE article singleton variant without eager/lazy */ public abstract aspect Singleton<Target> pertypewithin(Target) { private final Object lock = new Object(); private Target singleton; /** * Subaspects define this. All join points must return type Target. */ abstract protected pointcut creation(); pointcut creating() : cflow(within(Singleton+) && adviceexecution()); Target around() : creation() && !creating(){ synchronized(lock) { if (singleton == null) { singleton = proceed(); } return singleton; } } } ----------------- SingletonTest.java package com.isberg.articles.aop7.patterns; import junit.framework.TestCase; public class SingletonTest extends TestCase { public void testSingleton() throws Exception { C[] cs = {C.create(), new C(), C.create()}; for (int i = 1; i < cs.length; i++) { assertEquals(cs[0], cs[i]); } } static class C { static C create() {return new C();} C() {} } static aspect A extends Singleton<C> { protected pointcut creation() : execution(static C C.create()) || call(C.new()); } } --------------------------------------------------------------- trouble in:public class com.isberg.articles.aop7.patterns.SingletonTest extends junit.framework.TestCase: public void <init>(): ALOAD_0 // com.isberg.articles.aop7.patterns.SingletonTest this (line 5) INVOKESPECIAL junit.framework.TestCase.<init> ()V constructor-execution(void com.isberg.articles.aop7.patterns.SingletonTest.<init>()) | RETURN constructor-execution(void com.isberg.articles.aop7.patterns.SingletonTest.<init>()) end public void <init>() public void testSingleton() throws java.lang.Exception org.aspectj.weaver.MethodDeclarationLineNumber: 6:142 : method-execution(void com.isberg.articles.aop7.patterns.SingletonTest.testSingleton()) | ICONST_3 (line 7) | ANEWARRAY com.isberg.articles.aop7.patterns.SingletonTest$C | DUP | ICONST_0 | method-call(com.isberg.articles.aop7.patterns.SingletonTest$C com.isberg.articles.aop7.patterns.SingletonTest$C.create()) | | INVOKESTATIC com.isberg.articles.aop7.patterns.SingletonTest$C.create ()Lcom/isberg/articles/aop7/patterns/SingletonTest$C; | method-call(com.isberg.articles.aop7.patterns.SingletonTest$C com.isberg.articles.aop7.patterns.SingletonTest$C.create()) | AASTORE | DUP | ICONST_1 | constructor-call(void com.isberg.articles.aop7.patterns.SingletonTest$C.<init>()) | | NEW com.isberg.articles.aop7.patterns.SingletonTest$C | | DUP | | INVOKESPECIAL com.isberg.articles.aop7.patterns.SingletonTest$C.<init> ()V | constructor-call(void com.isberg.articles.aop7.patterns.SingletonTest$C.<init>()) | AASTORE | DUP | ICONST_2 | method-call(com.isberg.articles.aop7.patterns.SingletonTest$C com.isberg.articles.aop7.patterns.SingletonTest$C.create()) | | INVOKESTATIC com.isberg.articles.aop7.patterns.SingletonTest$C.create ()Lcom/isberg/articles/aop7/patterns/SingletonTest$C; | method-call(com.isberg.articles.aop7.patterns.SingletonTest$C com.isberg.articles.aop7.patterns.SingletonTest$C.create()) | AASTORE | ASTORE_1 | ICONST_1 (line 8) | ISTORE_2 | GOTO L1 | L0: ALOAD_1 // com.isberg.articles.aop7.patterns.SingletonTest$C[] cs (line 9) | ICONST_0 | AALOAD | ALOAD_1 // com.isberg.articles.aop7.patterns.SingletonTest$C[] cs | ILOAD_2 // int i | AALOAD | method-call(void junit.framework.Assert.assertEquals(java.lang.Object, java.lang.Object)) | | INVOKESTATIC com.isberg.articles.aop7.patterns.SingletonTest.assertEquals (Ljava/lang/Object;Ljava/lang/Object;)V | method-call(void junit.framework.Assert.assertEquals(java.lang.Object, java.lang.Object)) | IINC 2 1 // int i (line 8) | L1: ILOAD_2 // int i | ALOAD_1 // com.isberg.articles.aop7.patterns.SingletonTest$C[] cs | ARRAYLENGTH | IF_ICMPLT L0 | RETURN (line 11) method-execution(void com.isberg.articles.aop7.patterns.SingletonTest.testSingleton()) end public void testSingleton() throws java.lang.Exception end public class com.isberg.articles.aop7.patterns.SingletonTest when implementing on shadow constructor-call(void com.isberg.articles.aop7.patterns.SingletonTest$C.<init>()) when weaving type com.isberg.articles.aop7.patterns.SingletonTest when weaving classes when weaving when incrementally building BuildConfig[c:\home\ws\main-31\.metadata\.plugins\org.eclipse.ajdt.core\devworks-fall.generated.lst] #Files=90 org.aspectj.weaver.BCException: Class com.isberg.articles.aop7.patterns.Singleton does not have a method ajc$around$com_isberg_articles_aop7_patterns_Singleton$1$51e13820 with signature (Lorg/aspectj/runtime/internal/AroundClosure;)Ljava/lang/Object; when implementing on shadow constructor-call(void com.isberg.articles.aop7.patterns.SingletonTest$C.<init>()) when weaving type com.isberg.articles.aop7.patterns.SingletonTest when weaving classes when weaving when incrementally building BuildConfig[c:\home\ws\main-31\.metadata\.plugins\org.eclipse.ajdt.core\devworks-fall.generated.lst] #Files=90 at org.aspectj.weaver.bcel.LazyClassGen.getLazyMethodGen(LazyClassGen.java:1161) at org.aspectj.weaver.bcel.LazyClassGen.getLazyMethodGen(LazyClassGen.java:1146) at org.aspectj.weaver.bcel.BcelShadow.weaveAroundInline(BcelShadow.java:1973) at org.aspectj.weaver.bcel.BcelAdvice.implementOn(BcelAdvice.java:211) at org.aspectj.weaver.Shadow.implementMungers(Shadow.java:514) at org.aspectj.weaver.Shadow.implement(Shadow.java:391) at org.aspectj.weaver.bcel.BcelClassWeaver.implement(BcelClassWeaver.java:1782) at org.aspectj.weaver.bcel.BcelClassWeaver.weave(BcelClassWeaver.java:394) at org.aspectj.weaver.bcel.BcelClassWeaver.weave(BcelClassWeaver.java:98) at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:1478) at org.aspectj.weaver.bcel.BcelWeaver.weaveWithoutDump(BcelWeaver.java:1443) at org.aspectj.weaver.bcel.BcelWeaver.weaveAndNotify(BcelWeaver.java:1217) at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:1039) at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.weave(AjCompilerAdapter.java:300) at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.afterCompiling(AjCompilerAdapter.java:178) at org.aspectj.ajdt.internal.compiler.CompilerAdapter.ajc$afterReturning$org_aspectj_ajdt_internal_compiler_CompilerAdapter$2$f9cc9ca0(CompilerAdapter.aj:70) at org.aspectj.org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:367) at org.aspectj.ajdt.internal.core.builder.AjBuildManager.performCompilation(AjBuildManager.java:759) at org.aspectj.ajdt.internal.core.builder.AjBuildManager.doBuild(AjBuildManager.java:249) at org.aspectj.ajdt.internal.core.builder.AjBuildManager.incrementalBuild(AjBuildManager.java:158) at org.aspectj.ajde.internal.CompilerAdapter.compile(CompilerAdapter.java:117) at org.aspectj.ajde.internal.AspectJBuildManager$CompilerThread.run(AspectJBuildManager.java:191)